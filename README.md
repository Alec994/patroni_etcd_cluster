# PostgreSQL High-Availability Patroni/Etcd Cluster

## Инструкция по применению

1. Склонируйте данный репозиторий на предполагаемый "Контроллер Ansible" с которого будет запускаться плейбук (в системе должны быть установлены пакеты `ansible` и `ansible-core`):

    ```sh
    git clone https://github.com/Alec994/patroni_etcd_cluster.git
    ```

2. Создайте файл инвентаря (inventory), внесите в группы `etcd` и `patroni` имена узлов и их IP-адреса где будут устанавливаться Etcd и Patroni соответственно (файл-пример `inventory_example.ini`).
  
   > Обратите внимание, что СУБД PostgreSQL будет установлена на тех же узлах где и Patroni.

3. Сгенерируйте ssh-ключ на Контроллере Ansible. Скопируйте данный ключ на все настраиваемые узлы. У удаленного пользователя, от имени которого будет производится подключение к узлам должны быть права администратора (sudo). Также, имя пользователя должно совпадать на всех настраиваемых узлах (и желательно на Контроллере Ansible, чтобы не прописывать дополнительный ключ в команде). Команды для выполнения данного шага:

    ```sh
    # Генерация ключа
    ssh-keygen
    
    # Копирование ключа на удаленный узел (выполняется отдельно для всех узлов)
    ssh-copy-id administrator@cluster-node-01
    ```

4. Установите дополнительный модуль Ansible, необходимый для генерации ssl-сертификатов:

    ```sh
    ansible-galaxy collection install community.crypto
    ```

5. Сконфигурируйте плейбук с помощью файла `playconf.yml`. На данный момент можно настроить использования ssl-сертификатов (по умолчанию использование включено), для самих сертификатов можно изменить параметры subject'а, а также локальное расположение артефактов при их генерации.

6. Запустите плейбук с указанием inventory-файла и, опционально, именем удаленного пользователя (если оно отличается от локального):

    ```sh
    ansible-playbook -i inventory.ini playbook.yml
    # или
    ansible-playbook -u administrator -i inventory.ini playbook.yml
    ```

После выполения всех пунктов и завершению работы самого плейбука у вас должен быть сконфигурирован рабочий кластер. При возникновении трудностей или ошибок просьба [писать в Issues](https://github.com/Alec994/patroni_etcd_cluster/issues/new) к данному репозиторию с подробным описанием вопроса/ошибки, выполняемых командах и информацией о системе.
